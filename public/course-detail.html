<!DOCTYPE html>
<html>
<head>
    <title>Course Details</title>
    <style>
        /* Basic styling for the course details */
        .detail-label {
            font-weight: bold;
        }
        .detail-value {
            margin-bottom: 10px;
        }
        /* Style for the average review display */
        #average-review {
            font-size: 1.2em;
            margin-top: 10px;
        }
        /* Style for the visual bar */
        #review-bar-container {
            width: 100%;
            background-color: #f0f0f0; /* Light grey background */
            margin-top: 5px;
        }
        #review-bar {
            width: 0%; /* Initial width */
            height: 20px;
            background-color: #4caf50; /* Green color for the bar */
        }
    </style>
</head>
<body>
    <h1>Course Details</h1>
    <div id="course-details">
        </div>
    <div id="average-review">
        <span class="detail-label">Average Review:</span>
        <span id="average-score"></span>
    </div>
    <div id="review-bar-container">
        <div id="review-bar"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const courseDetailsDiv = document.getElementById('course-details');
            const averageScoreSpan = document.getElementById('average-score');
            const reviewBar = document.getElementById('review-bar');

            // Function to get the course ID from the query parameter
            const getCourseId = () => {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('courseId');
            };

            // Function to fetch and display course details from Firestore
            const fetchCourseDetails = async (courseId) => {
                // Replace with your Firebase initialization and firestore reference
                const db = firebase.firestore(); // Get Firestore reference

                try {
                    const courseDoc = await db.collection('courses').doc(courseId).get();

                    if (courseDoc.exists) {
                        const courseData = courseDoc.data();

                        // Create and append elements to display course details
                        const courseCodeDiv = document.createElement('div');
                        courseCodeDiv.classList.add('detail-item');
                        courseCodeDiv.innerHTML = `<span class="detail-label">Course Code:</span> <span class="detail-value">${courseData.courseCode}</span>`;
                        courseDetailsDiv.appendChild(courseCodeDiv);

                        const courseNameDiv = document.createElement('div');
                        courseNameDiv.classList.add('detail-item');
                        courseNameDiv.innerHTML = `<span class="detail-label">Course Name:</span> <span class="detail-value">${courseData.courseName}</span>`;
                        courseDetailsDiv.appendChild(courseNameDiv);

                        const creditsDiv = document.createElement('div');
                        creditsDiv.classList.add('detail-item');
                        creditsDiv.innerHTML = `<span class="detail-label">Credits:</span> <span class="detail-value">${courseData.credits}</span>`;
                        courseDetailsDiv.appendChild(creditsDiv);

                        // Add other details as needed...

                        // Calculate and display average review
                        calculateAndDisplayAverage(courseId);

                    } else {
                        courseDetailsDiv.textContent = 'Course not found.';
                    }
                } catch (error) {
                    console.error('Error fetching course details:', error);
                    courseDetailsDiv.textContent = 'Error loading course details.';
                }
            };

            // Function to calculate and display the average review
            const calculateAndDisplayAverage = async (courseId) => {
                // Replace with your Firebase initialization and firestore reference
                const db = firebase.firestore(); // Get Firestore reference

                try {
                    const reviewsDoc = await db.collection('reviews').doc(courseId).get();

                    if (reviewsDoc.exists) {
                        const reviewsData = reviewsDoc.data();
                        let totalScore = 0;
                        let reviewCount = 0;

                        // Iterate through the reviews (assuming they are stored as a map)
                        for (const teacher in reviewsData) {
                            const userReviewRef = reviewsData[teacher]; // Reference to user review
                            if (userReviewRef) {
                                const userReviewDoc = await userReviewRef.get();
                                if (userReviewDoc.exists) {
                                    const userReview = userReviewDoc.data();
                                    // Calculate average based on numerical review fields
                                    totalScore += userReview.homework;
                                    totalScore += userReview.subjectRigor;
                                    totalScore += userReview.teacherInvolvement;
                                    totalScore += userReview.workload;
                                    reviewCount += 4; // Assuming 4 numerical review fields
                                }
                            }
                        }

                        if (reviewCount > 0) {
                            const averageScore = totalScore / reviewCount;
                            averageScoreSpan.textContent = averageScore.toFixed(2); // Display average with 2 decimal places
                            // Update the width of the review bar
                            const percentage = (averageScore / 5) * 100;
                            reviewBar.style.width = percentage + '%';
                        } else {
                            averageScoreSpan.textContent = 'No reviews yet';
                            reviewBar.style.width = '0%';
                        }
                    } else {
                        averageScoreSpan.textContent = 'No reviews yet';
                        reviewBar.style.width = '0%';
                    }
                } catch (error) {
                    console.error('Error calculating average review:', error);
                    averageScoreSpan.textContent = 'Error loading reviews';
                    reviewBar.style.width = '0%';
                }
            };

            const courseId = getCourseId();
            if (courseId) {
                fetchCourseDetails(courseId);
            } else {
                courseDetailsDiv.textContent = 'No course ID provided.';
            }
        });
    </script>
    <script src="/__/firebase/8.6.8/firebase-app.js"></script>
    <script src="/__/firebase/8.6.8/firebase-firestore.js"></script>
    <script src="/__/firebase/init.js"></script>
</body>
</html>
